#!/bin/bash

set -euo pipefail

if ! ping -c 1 localhost &> /dev/null
then
  echo "localhost not accessible, did you add it to /etc/hosts?"
  exit 1
fi

if ! command -v mkcert &> /dev/null
then
    echo "mkcert could not be found. See https://mkcert.org/"
    exit 1
fi

echo "Installing self-signed development certificate"
mkcert -install
(
    mkdir -p projects/common/ssh
    cd projects/common/ssh
    mkcert localhost
)

echo "Installing project dependencies"
npm ci
(cd projects/client; npm ci)
(cd projects/server; npm ci)
(cd projects/keyboard; npm ci)

echo "Building development images"
DOCKER_ENV=dev bin/dcp build \
  --no-cache \
  --force-rm \
  --parallel
